# Aquarius - Automation Simplified
#
# @brief Git script for exporting PCB data for Power Module
# @note only runs when files are checked in
# @date 5/16/25
# @author cyberreefguru
# (c) CRG Makes 2025
name: Aquarius-Power-Module-Checkin-CI
on:
  push:
    paths:
      # - 'pcb/power-module.kicad_sch'
      - 'pcb/power-module.kicad_pcb'
      # - 'pcb/power-module-checkin.kibot.yaml'
      - '.github/workflows/power-module-checkin.yaml'
  workflow_dispatch:
    
jobs:
  export-ecad:
    name: Export ECAD
    runs-on: ubuntu-latest
    container: ghcr.io/inti-cmnb/kicad9_auto_full:latest
      
    steps:
    - name: Update system
      run: |
        echo "Working Directory $(pwd)"
        apt update
        apt -y install git zip

    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        path: working/module-power

    - name: Checkout Extras
      uses: actions/checkout@v4
      with:
        repository: crgmakes/kicad-extras
        path: working/kicad-extras

    - name: Checkout CRGM Library
      uses: actions/checkout@v4
      with:
        repository: crgmakes/kicad-library
        path: working/kicad-library

    - name: Checkout PcbDraw Library
      uses: actions/checkout@v4
      with:
        repository: yaqwsx/PcbDraw-Lib
        path: working/PcbDraw-Lib

    - name: Checkout Fab Kit Library
      uses: actions/checkout@v4
      with:
        repository: bennymeg/Fabrication-Toolkit
        path: working/Fabrication-Toolkit

    - name: Update fonts
      run: |
        mkdir -p /usr/share/fonts/
        cp working/kicad-extras/fonts/* /usr/share/fonts/
        fc-cache -f -v

    - name: Update the PCB with git hash
      run: |
        cd working/module-power
        export COMMIT=$(git rev-parse --short HEAD)
        echo "COMMIT = ${COMMIT}"    
        echo "ref: ${{ github.ref }}"
        echo "default: ${{ env.default }}"
        cd pcb
        sed -i "s!<<hash>>!${COMMIT}!" power-module.kicad_pcb
        #sed -i.bak 's|\${KICAD_USER_MODEL_DIR}|../crgm/models|g' pcb/power-module.kicad_pcb

    - name: Generate Fabrication Files
      run: |
        echo "Working Directory: ${{ github.workspace }}"
        cd working/module-power/
        kibot -c ../kicad-extras/kibot/crgm.kibot.yaml -e pcb/power-module.kicad_sch -b pcb/power-module.kicad_pcb -d production compress_jlc_4layer
        ls -AlF production
        # ls -AlF ${{ github.workspace }}/working/module-power/production

    - name: Generate Panel PCB
      # if: github.event_name == 'release'
      run: |
        cd working/module-power/pcb/panel
        rm -rf production
        kibot -c ../../../kicad-extras/kibot/crgm.kibot.yaml -e ../power-module.kicad_sch -b ../power-module.kicad_pcb -d pcb panelize
        kibot -c ../../../kicad-extras/kibot/crgm.kibot.yaml -e ../power-module.kicad_sch -b pcb/power-module-panel.kicad_pcb -d production compress_jlc_4layer_panel
        mv production/power-module-panel-fab.zip .
        zip -u power-module-panel-fab.zip pcb/**

    - name: Upload PCB Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: aquarius-power-module-pcb
        path: |
          working/module-power/production/power-module-fab.zip
        if-no-files-found: warn
        retention-days: 30

    - name: Upload Panel Artifacts
      # if: github.event_name == 'release'
      uses: actions/upload-artifact@v4
      with:
        name: aquarius-power-module-panel
        path: |
          working/module-power/pcb/panel/power-module-panel-fab.zip
        if-no-files-found: warn
        retention-days: 30